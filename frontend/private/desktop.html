<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NebulaCore Desktop</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/polish.css">
  <script src="/js/default-avatar.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: #0a0a0f;
      color: #fff;
      min-height: 100vh;
      overflow: hidden;
      user-select: none;
    }
    
    .desktop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 52px;
      background: linear-gradient(135deg, #0d1117 0%, #161b22 50%, #0d1117 100%);
      display: flex;
      padding: 16px;
      gap: 16px;
    }
    
    /* Left Panel - Quick Access */
    .left-panel {
      width: 280px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .widget {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 16px;
      backdrop-filter: blur(20px);
    }
    
    .widget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .widget-title {
      font-size: 13px;
      font-weight: 600;
      color: rgba(255,255,255,0.9);
    }
    
    .widget-more {
      font-size: 11px;
      color: #60a5fa;
      cursor: pointer;
    }
    
    /* Clock Widget */
    .clock-widget .time {
      font-size: 48px;
      font-weight: 300;
      letter-spacing: -2px;
      margin-bottom: 4px;
    }
    
    .clock-widget .date {
      font-size: 14px;
      color: rgba(255,255,255,0.6);
    }
    
    /* Quick Access */
    .quick-access-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    
    .quick-app {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .quick-app:hover {
      background: rgba(255,255,255,0.08);
    }
    
    .quick-app-icon {
      font-size: 24px;
      margin-bottom: 6px;
    }
    
    .quick-app-name {
      font-size: 10px;
      color: rgba(255,255,255,0.7);
      text-align: center;
    }
    
    /* Main Content Area */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    /* Recent Activity */
    .activity-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .activity-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .activity-item:hover {
      background: rgba(255,255,255,0.06);
    }
    
    .activity-icon {
      width: 36px;
      height: 36px;
      background: rgba(96,165,250,0.15);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    
    .activity-info {
      flex: 1;
    }
    
    .activity-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 2px;
    }
    
    .activity-meta {
      font-size: 11px;
      color: rgba(255,255,255,0.5);
    }
    
    /* Right Panel - Widgets */
    .right-panel {
      width: 260px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    /* Tasks Widget */
    .task-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    
    .task-item:last-child {
      border-bottom: none;
    }
    
    .task-check {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 4px;
      cursor: pointer;
    }
    
    .task-check.done {
      background: #22c55e;
      border-color: #22c55e;
    }
    
    .task-text {
      font-size: 12px;
      color: rgba(255,255,255,0.8);
    }
    
    /* Taskbar */
    .taskbar {
      position: fixed;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      height: 52px;
      background: rgba(24, 24, 27, 0.85);
      backdrop-filter: blur(30px) saturate(150%);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      padding: 0 8px;
      gap: 4px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }
    
    .taskbar-section {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .taskbar-divider {
      width: 1px;
      height: 24px;
      background: rgba(255,255,255,0.1);
      margin: 0 8px;
    }
    
    .taskbar-btn {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
      font-size: 20px;
      position: relative;
    }
    
    .taskbar-btn:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .taskbar-btn.active {
      background: rgba(96,165,250,0.2);
    }
    
    .taskbar-btn.open::after {
      content: '';
      position: absolute;
      bottom: 4px;
      width: 5px;
      height: 5px;
      background: rgba(255,255,255,0.5);
      border-radius: 50%;
    }
    
    .taskbar-btn.open.focused::after {
      width: 16px;
      height: 3px;
      background: #60a5fa;
      border-radius: 2px;
    }
    
    .pinned-apps {
      display: flex;
      gap: 4px;
    }
    
    .open-apps {
      display: flex;
      gap: 4px;
    }
    
    /* System Tray */
    .system-tray {
      position: fixed;
      bottom: 8px;
      right: 16px;
      height: 44px;
      background: rgba(24, 24, 27, 0.85);
      backdrop-filter: blur(30px);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      padding: 0 12px;
      gap: 12px;
    }
    
    .tray-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .tray-item:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .tray-icons {
      display: flex;
      gap: 4px;
      font-size: 14px;
      opacity: 0.8;
    }
    
    .tray-time {
      text-align: right;
    }
    
    .tray-clock {
      font-weight: 500;
    }
    
    .tray-date {
      font-size: 10px;
      opacity: 0.7;
    }
    
    .tray-avatar {
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, #60a5fa, #a78bfa);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      overflow: hidden;
    }
    
    .tray-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    /* App Launcher */
    .launcher {
      position: fixed;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%) scale(0.95);
      width: 680px;
      background: rgba(24, 24, 27, 0.95);
      backdrop-filter: blur(40px);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 16px 64px rgba(0,0,0,0.5);
      opacity: 0;
      pointer-events: none;
      transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
      overflow: hidden;
    }
    
    .launcher.active {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) scale(1);
    }
    
    .launcher-search {
      padding: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    
    .launcher-search input {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      outline: none;
    }
    
    .launcher-search input:focus {
      border-color: #60a5fa;
    }
    
    .launcher-search input::placeholder {
      color: rgba(255,255,255,0.4);
    }
    
    .launcher-tabs {
      display: flex;
      padding: 0 16px;
      gap: 4px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    
    .launcher-tab {
      padding: 12px 16px;
      font-size: 12px;
      font-weight: 500;
      color: rgba(255,255,255,0.5);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.15s;
    }
    
    .launcher-tab:hover {
      color: rgba(255,255,255,0.8);
    }
    
    .launcher-tab.active {
      color: #60a5fa;
      border-bottom-color: #60a5fa;
    }
    
    .launcher-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      padding: 16px;
      max-height: 320px;
      overflow-y: auto;
    }
    
    .launcher-app {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px 8px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .launcher-app:hover {
      background: rgba(255,255,255,0.08);
    }
    
    .launcher-app-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    
    .launcher-app-name {
      font-size: 11px;
      color: rgba(255,255,255,0.8);
      text-align: center;
    }
    
    /* App Window */
    .app-window {
      position: fixed;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      width: 85%;
      max-width: 1100px;
      height: calc(100vh - 120px);
      background: #18181b;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
      display: none;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 25px 80px rgba(0,0,0,0.5);
    }
    
    .app-window.active {
      display: flex;
      animation: windowOpen 0.2s ease;
    }
    
    .app-window.focused {
      box-shadow: 0 25px 80px rgba(0,0,0,0.5), 0 0 0 2px rgba(96,165,250,0.3);
    }
    
    .app-window.maximized {
      top: 0;
      left: 0;
      right: 0;
      bottom: 60px;
      width: 100%;
      max-width: 100%;
      height: calc(100vh - 60px);
      border-radius: 0;
      transform: none;
    }
    
    @keyframes windowOpen {
      from { opacity: 0; transform: translateX(-50%) scale(0.95); }
      to { opacity: 1; transform: translateX(-50%) scale(1); }
    }
    
    .window-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 40px;
      background: #1f1f23;
      padding: 0 12px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    
    .window-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 500;
    }
    
    .window-icon {
      font-size: 16px;
    }
    
    .window-controls {
      display: flex;
      gap: 8px;
    }
    
    .window-btn {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.1s;
    }
    
    .window-btn:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .window-btn.close:hover {
      background: #ef4444;
    }
    
    .window-content {
      flex: 1;
      overflow: hidden;
      background: #0f0f12;
    }
    
    .window-content iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    /* Context Menu */
    .context-menu {
      position: fixed;
      background: rgba(30, 30, 35, 0.98);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 6px;
      min-width: 180px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      z-index: 10000;
      display: none;
    }
    
    .context-menu.active {
      display: block;
    }
    
    .context-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      font-size: 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.1s;
    }
    
    .context-item:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .context-divider {
      height: 1px;
      background: rgba(255,255,255,0.08);
      margin: 4px 0;
    }
    
    /* Notifications */
    .notification-container {
      position: fixed;
      top: 16px;
      right: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 10000;
    }
    
    .notification {
      background: rgba(30, 30, 35, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 14px 16px;
      min-width: 300px;
      max-width: 380px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .notification-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    
    .notification-icon {
      font-size: 16px;
    }
    
    .notification-app {
      font-size: 11px;
      font-weight: 600;
      color: rgba(255,255,255,0.6);
    }
    
    .notification-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .notification-body {
      font-size: 12px;
      color: rgba(255,255,255,0.7);
    }
  </style>
</head>
<body>
  <div class="desktop">
    <!-- Left Panel -->
    <div class="left-panel">
      <div class="widget clock-widget">
        <div class="time" id="widgetTime">12:00</div>
        <div class="date" id="widgetDate">Wednesday, December 18</div>
      </div>
      
      <div class="widget">
        <div class="widget-header">
          <span class="widget-title">Quick Access</span>
        </div>
        <div class="quick-access-grid">
          <div class="quick-app" data-app="games"><div class="quick-app-icon">üéÆ</div><div class="quick-app-name">Games</div></div>
          <div class="quick-app" data-app="chat"><div class="quick-app-icon">üí¨</div><div class="quick-app-name">Chat</div></div>
          <div class="quick-app" data-app="videos"><div class="quick-app-icon">üé¨</div><div class="quick-app-name">Videos</div></div>
          <div class="quick-app" data-app="music"><div class="quick-app-icon">üéµ</div><div class="quick-app-name">Music</div></div>
          <div class="quick-app" data-app="proxy"><div class="quick-app-icon">üåê</div><div class="quick-app-name">Browser</div></div>
          <div class="quick-app" data-app="apps"><div class="quick-app-icon">üî¢</div><div class="quick-app-name">Apps</div></div>
          <div class="quick-app" data-app="forums"><div class="quick-app-icon">üìù</div><div class="quick-app-name">Forums</div></div>
          <div class="quick-app" data-app="ai-chat"><div class="quick-app-icon">ü§ñ</div><div class="quick-app-name">Nova AI</div></div>
          <div class="quick-app" data-app="settings"><div class="quick-app-icon">‚öôÔ∏è</div><div class="quick-app-name">Settings</div></div>
        </div>
      </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
    </div>
    
    <!-- Right Panel -->
    <div class="right-panel">
      <div class="widget" style="cursor:pointer" onclick="openApp('tasks')">
        <div class="widget-header">
          <span class="widget-title">My Tasks</span>
          <span class="widget-more">Open ‚Üí</span>
        </div>
        <div class="task-item"><div class="task-check"></div><div class="task-text">Complete daily login</div></div>
        <div class="task-item"><div class="task-check done"></div><div class="task-text">Check announcements</div></div>
        <div class="task-item"><div class="task-check"></div><div class="task-text">Reach level 10</div></div>
      </div>
      
      <div class="widget">
        <div class="widget-header">
          <span class="widget-title">Announcements</span>
        </div>
        <div style="font-size:12px;color:rgba(255,255,255,0.7);line-height:1.5">
          Welcome to NebulaCore! Explore games, chat with friends, and earn XP.
        </div>
      </div>
    </div>
  </div>
  
  <!-- Taskbar -->
  <div class="taskbar">
    <div class="taskbar-section">
      <div class="taskbar-btn" id="launcherBtn" onclick="toggleLauncher()">
        <svg width="18" height="18" viewBox="0 0 18 18" fill="currentColor">
          <rect x="1" y="1" width="7" height="7" rx="1.5"/>
          <rect x="10" y="1" width="7" height="7" rx="1.5"/>
          <rect x="1" y="10" width="7" height="7" rx="1.5"/>
          <rect x="10" y="10" width="7" height="7" rx="1.5"/>
        </svg>
      </div>
    </div>
    <div class="taskbar-divider"></div>
    <div class="taskbar-section pinned-apps">
      <div class="taskbar-btn" data-app="games" title="Games">üéÆ</div>
      <div class="taskbar-btn" data-app="chat" title="Chat">üí¨</div>
      <div class="taskbar-btn" data-app="proxy" title="Browser">üåê</div>
      <div class="taskbar-btn" data-app="videos" title="Videos">üé¨</div>
      <div class="taskbar-btn" data-app="music" title="Music">üéµ</div>
    </div>
    <div class="taskbar-divider"></div>
    <div class="taskbar-section open-apps" id="openApps"></div>
  </div>
  
  <!-- System Tray -->
  <div class="system-tray">
    <div class="tray-item" onclick="toggleVolumePanel()" style="cursor:pointer" title="Volume">
      <div class="tray-icons">üîä üì∂</div>
    </div>
    <div class="tray-item">
      <div class="tray-time">
        <div class="tray-clock" id="trayClock">12:00 PM</div>
        <div class="tray-date" id="trayDate">12/18/2025</div>
      </div>
    </div>
    <div class="tray-avatar" id="trayAvatar">üë§</div>
  </div>
  
  <!-- Volume Control Panel -->
  <div id="volumePanel" style="display:none; position:fixed; bottom:50px; right:120px; background:rgba(20,20,35,0.95); backdrop-filter:blur(20px); border-radius:12px; padding:20px; min-width:280px; z-index:99998; border:1px solid rgba(255,255,255,0.1); box-shadow:0 10px 40px rgba(0,0,0,0.5);">
    <div style="font-weight:600; margin-bottom:15px; color:var(--text,#fff);">üîä Volume Control</div>
    
    <div style="margin-bottom:15px;">
      <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
        <span style="font-size:13px; color:rgba(255,255,255,0.7);">üéµ Music</span>
        <span id="musicVolVal" style="font-size:12px; color:var(--accent,#00d4ff);">100%</span>
      </div>
      <input type="range" id="musicVolume" min="0" max="100" value="100" style="width:100%; accent-color:var(--accent,#00d4ff);" oninput="updateVolume('music', this.value)">
    </div>
    
    <div style="margin-bottom:15px;">
      <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
        <span style="font-size:13px; color:rgba(255,255,255,0.7);">üé¨ Videos</span>
        <span id="videoVolVal" style="font-size:12px; color:var(--accent,#00d4ff);">100%</span>
      </div>
      <input type="range" id="videoVolume" min="0" max="100" value="100" style="width:100%; accent-color:var(--accent,#00d4ff);" oninput="updateVolume('video', this.value)">
    </div>
    
    <div style="margin-bottom:10px;">
      <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
        <span style="font-size:13px; color:rgba(255,255,255,0.7);">üîî Notifications</span>
        <span id="notifVolVal" style="font-size:12px; color:var(--accent,#00d4ff);">100%</span>
      </div>
      <input type="range" id="notifVolume" min="0" max="100" value="100" style="width:100%; accent-color:var(--accent,#00d4ff);" oninput="updateVolume('notif', this.value)">
    </div>
    
    <div style="border-top:1px solid rgba(255,255,255,0.1); padding-top:12px; margin-top:12px;">
      <label style="display:flex; align-items:center; gap:10px; cursor:pointer; font-size:13px; color:rgba(255,255,255,0.7);">
        <input type="checkbox" id="muteAll" onchange="toggleMuteAll()" style="accent-color:var(--accent,#00d4ff);">
        Mute All
      </label>
    </div>
  </div>
  
  <!-- App Launcher -->
  <div class="launcher" id="launcher">
    <div class="launcher-search">
      <input type="text" placeholder="Search apps, games, and more..." id="launcherSearch">
    </div>
    <div class="launcher-tabs">
      <div class="launcher-tab active" data-cat="all">All</div>
      <div class="launcher-tab" data-cat="productivity">Productivity</div>
      <div class="launcher-tab" data-cat="media">Media</div>
      <div class="launcher-tab" data-cat="social">Social</div>
      <div class="launcher-tab" data-cat="tools">Tools</div>
    </div>
    <div class="launcher-grid" id="launcherGrid"></div>
  </div>
  
  <!-- App Window -->
  <div class="app-window focused" id="appWindow">
    <div class="window-header">
      <div class="window-title">
        <span class="window-icon" id="windowIcon">üìÅ</span>
        <span id="windowTitle">App</span>
      </div>
      <div class="window-controls">
        <div class="window-btn" onclick="minimizeWindow()">‚àí</div>
        <div class="window-btn" onclick="toggleMaximize()">‚ñ°</div>
        <div class="window-btn close" onclick="closeWindow()">√ó</div>
      </div>
    </div>
    <div class="window-content">
      <iframe id="appFrame" src=""></iframe>
    </div>
  </div>
  
  <!-- Context Menu for Apps -->
  <div class="context-menu" id="contextMenu">
    <div class="context-item" id="ctxOpen">üìÇ Open</div>
    <div class="context-item" id="ctxNewWindow">ü™ü New window</div>
    <div class="context-divider"></div>
    <div class="context-item" id="ctxPin">üìå Pin to taskbar</div>
    <div class="context-item" id="ctxUnpin">‚ùå Unpin</div>
    <div class="context-divider"></div>
    <div class="context-item" id="ctxClose">üö™ Close</div>
  </div>
  
  <!-- Desktop Context Menu (left-click on desktop) -->
  <div class="context-menu" id="desktopContextMenu" style="min-width: 200px;">
    <div class="context-item" onclick="openWallpaperPicker()">üñºÔ∏è Change Wallpaper</div>
    <div class="context-item" onclick="openApp('themes')">üé® Change Theme</div>
    <div class="context-divider"></div>
    <div class="context-item" onclick="openApp('settings')">‚öôÔ∏è Settings</div>
    <div class="context-item" onclick="refreshDesktop()">üîÑ Refresh</div>
    <div class="context-divider"></div>
    <div class="context-item" onclick="toggleLauncher()">üì± Open Launcher</div>
  </div>
  
  <!-- Wallpaper Picker Modal -->
  <div id="wallpaperModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:99999; align-items:center; justify-content:center;">
    <div style="background:var(--card, #1a1a2e); border-radius:16px; padding:30px; max-width:600px; width:90%;">
      <h3 style="margin:0 0 20px; color:var(--text, #fff);">Choose Wallpaper</h3>
      <div id="wallpaperGrid" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:20px;"></div>
      
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:15px;">
        <input type="file" id="wallpaperFileInput" accept="image/*" style="display:none;">
        <button onclick="document.getElementById('wallpaperFileInput').click()" style="flex:1; padding:12px; background:var(--primary, #6c5ce7); border:none; border-radius:8px; color:#fff; cursor:pointer; font-weight:600;">üìÅ Upload from Files</button>
      </div>
      <div id="uploadPreview" style="display:none; margin-bottom:15px; text-align:center;">
        <img id="uploadPreviewImg" style="max-height:100px; border-radius:8px; margin-bottom:8px;">
        <div style="display:flex; gap:10px; justify-content:center;">
          <button onclick="applyUploadedWallpaper()" style="padding:10px 20px; background:var(--accent, #00d4ff); border:none; border-radius:8px; cursor:pointer; font-weight:600;">Apply Upload</button>
          <button onclick="cancelUpload()" style="padding:10px 20px; background:#ff4444; border:none; border-radius:8px; color:#fff; cursor:pointer;">Cancel</button>
        </div>
        <div id="uploadStatus" style="margin-top:8px; font-size:12px; color:var(--text-secondary, #888);"></div>
      </div>
      
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:20px;">
        <input type="text" id="customWallpaperUrl" placeholder="Or paste image URL..." style="flex:1; padding:12px; background:var(--bg, #0a0a14); border:1px solid var(--accent, #00d4ff); border-radius:8px; color:var(--text, #fff);">
        <button onclick="setCustomWallpaper()" style="padding:12px 20px; background:var(--accent, #00d4ff); border:none; border-radius:8px; cursor:pointer; font-weight:600;">Apply</button>
      </div>
      <button onclick="closeWallpaperPicker()" style="width:100%; padding:12px; background:transparent; border:1px solid var(--accent, #00d4ff); border-radius:8px; color:var(--text, #fff); cursor:pointer;">Cancel</button>
    </div>
  </div>
  
  <!-- Notifications Container -->
  <div class="notification-container" id="notifications"></div>

  <script>
    let launcherOpen = false;
    let openApps = [];
    let currentApp = null;
    let pinnedApps = ['games', 'chat', 'proxy', 'videos', 'music'];
    let currentCat = 'all';
    
    const apps = {
      games: { title: 'Games', icon: 'üéÆ', cat: 'media' },
      chat: { title: 'Chat', icon: 'üí¨', cat: 'social' },
      proxy: { title: 'Browser', icon: 'üåê', cat: 'productivity' },
      videos: { title: 'Videos', icon: 'üé¨', cat: 'media' },
      music: { title: 'Music', icon: 'üéµ', cat: 'media' },
      soundboard: { title: 'Soundboard', icon: 'üîä', cat: 'media' },
      apps: { title: 'Apps', icon: 'üî¢', cat: 'tools' },
      forums: { title: 'Forums', icon: 'üìù', cat: 'social' },
      settings: { title: 'Settings', icon: '‚öôÔ∏è', cat: 'tools' },
      shop: { title: 'Store', icon: 'üõí', cat: 'productivity' },
      admin: { title: 'Admin', icon: 'üîß', cat: 'tools' },
      tasks: { title: 'Tasks', icon: '‚úÖ', cat: 'productivity' },
      bugs: { title: 'Feedback', icon: 'üìã', cat: 'tools' },
      themes: { title: 'Themes', icon: 'üé®', cat: 'tools' },
      profile: { title: 'Profile', icon: 'üë§', cat: 'social' },
      leaderboard: { title: 'Leaderboard', icon: 'üèÜ', cat: 'social' },
      'ai-chat': { title: 'Nova AI', icon: 'ü§ñ', cat: 'productivity' }
    };
    
    function updateClock() {
      const now = new Date();
      const h = now.getHours();
      const m = now.getMinutes().toString().padStart(2, '0');
      const ampm = h >= 12 ? 'PM' : 'AM';
      const h12 = h % 12 || 12;
      
      document.getElementById('widgetTime').textContent = `${h12}:${m}`;
      document.getElementById('trayClock').textContent = `${h12}:${m} ${ampm}`;
      
      const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
      const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      document.getElementById('widgetDate').textContent = `${days[now.getDay()]}, ${months[now.getMonth()]} ${now.getDate()}`;
      document.getElementById('trayDate').textContent = `${now.getMonth()+1}/${now.getDate()}/${now.getFullYear()}`;
    }
    
    function toggleLauncher() {
      launcherOpen = !launcherOpen;
      document.getElementById('launcher').classList.toggle('active', launcherOpen);
      document.getElementById('launcherBtn').classList.toggle('active', launcherOpen);
      if (launcherOpen) renderLauncher('all');
    }
    
    function renderLauncher(cat) {
      const grid = document.getElementById('launcherGrid');
      grid.innerHTML = Object.entries(apps)
        .filter(([k, v]) => cat === 'all' || v.cat === cat)
        .map(([k, v]) => `
          <div class="launcher-app" data-app="${k}">
            <div class="launcher-app-icon">${v.icon}</div>
            <div class="launcher-app-name">${v.title}</div>
          </div>
        `).join('');
      
      grid.querySelectorAll('.launcher-app').forEach(el => {
        el.onclick = () => openApp(el.dataset.app);
      });
    }
    
    document.querySelectorAll('.launcher-tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.launcher-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentCat = tab.dataset.cat;
        document.getElementById('launcherSearch').value = '';
        renderLauncher(currentCat);
      };
    });
    
    function updateTaskbar() {
      const container = document.getElementById('openApps');
      container.innerHTML = '';
      
      openApps.filter(a => !pinnedApps.includes(a)).forEach(appName => {
        const app = apps[appName] || { icon: 'üìÅ' };
        const btn = document.createElement('div');
        btn.className = 'taskbar-btn open';
        btn.dataset.app = appName;
        btn.textContent = app.icon;
        btn.title = app.title || appName;
        
        if (appName === currentApp && document.getElementById('appWindow').classList.contains('active')) {
          btn.classList.add('focused');
        }
        
        btn.onclick = () => toggleApp(appName);
        container.appendChild(btn);
      });
      
      document.querySelectorAll('.pinned-apps .taskbar-btn').forEach(btn => {
        const app = btn.dataset.app;
        btn.classList.toggle('open', openApps.includes(app));
        btn.classList.toggle('focused', app === currentApp && document.getElementById('appWindow').classList.contains('active'));
      });
    }
    
    function toggleApp(appName) {
      const win = document.getElementById('appWindow');
      if (appName === currentApp && win.classList.contains('active')) {
        minimizeWindow();
      } else {
        openApp(appName);
      }
    }
    
    function openApp(appName) {
      const win = document.getElementById('appWindow');
      const frame = document.getElementById('appFrame');
      const app = apps[appName] || { title: appName, icon: 'üìÅ' };
      
      // Map app names to correct URLs
      const urlMap = {
        themes: '/theme-creator',
        tasks: '/tasks',
        bugs: '/private/bug-report.html',
        profile: '/stats',
        leaderboard: '/stats#leaderboard',
        soundboard: '/private/soundboard.html'
      };
      
      document.getElementById('windowTitle').textContent = app.title;
      document.getElementById('windowIcon').textContent = app.icon;
      frame.src = urlMap[appName] || `/pages/${appName}`;
      win.classList.add('active');
      
      if (!openApps.includes(appName)) openApps.push(appName);
      currentApp = appName;
      
      updateTaskbar();
      if (launcherOpen) toggleLauncher();
    }
    
    function closeWindow() {
      const win = document.getElementById('appWindow');
      win.classList.remove('active', 'maximized');
      document.getElementById('appFrame').src = '';
      if (currentApp) openApps = openApps.filter(a => a !== currentApp);
      currentApp = null;
      updateTaskbar();
    }
    
    function minimizeWindow() {
      document.getElementById('appWindow').classList.remove('active');
      updateTaskbar();
    }
    
    function toggleMaximize() {
      document.getElementById('appWindow').classList.toggle('maximized');
    }
    
    // Notification system
    let notifications = [];
    function showNotification(title, body, icon = 'üîî', duration = 5000) {
      const container = document.getElementById('notifications');
      const notif = document.createElement('div');
      notif.className = 'notification';
      notif.innerHTML = `
        <div class="notification-header">
          <span class="notification-icon">${icon}</span>
          <span class="notification-app">NebulaCore</span>
        </div>
        <div class="notification-title">${title}</div>
        <div class="notification-body">${body}</div>
      `;
      container.appendChild(notif);
      notifications.push(notif);
      if (notifications.length > 3) {
        const oldest = notifications.shift();
        oldest.remove();
      }
      setTimeout(() => {
        notif.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => notif.remove(), 300);
        notifications = notifications.filter(n => n !== notif);
      }, duration);
    }
    
    // Search filtering
    document.getElementById('launcherSearch').addEventListener('input', e => {
      const query = e.target.value.toLowerCase().trim();
      const grid = document.getElementById('launcherGrid');
      grid.innerHTML = Object.entries(apps)
        .filter(([k, v]) => (currentCat === 'all' || v.cat === currentCat) && 
          (v.title.toLowerCase().includes(query) || k.includes(query)))
        .map(([k, v]) => `
          <div class="launcher-app" data-app="${k}">
            <div class="launcher-app-icon">${v.icon}</div>
            <div class="launcher-app-name">${v.title}</div>
          </div>
        `).join('');
      grid.querySelectorAll('.launcher-app').forEach(el => {
        el.onclick = () => openApp(el.dataset.app);
      });
    });
    
    // Event listeners - Quick access and activity items
    document.querySelectorAll('.quick-app, .activity-item').forEach(el => {
      el.onclick = () => openApp(el.dataset.app);
    });
    
    // Pinned taskbar apps use toggleApp
    document.querySelectorAll('.pinned-apps .taskbar-btn').forEach(btn => {
      btn.onclick = () => toggleApp(btn.dataset.app);
      btn.oncontextmenu = e => {
        e.preventDefault();
        const menu = document.getElementById('contextMenu');
        menu.style.left = e.clientX + 'px';
        menu.style.bottom = '60px';
        menu.style.top = 'auto';
        menu.classList.add('active');
        menu.dataset.app = btn.dataset.app;
      };
    });
    
    document.addEventListener('click', e => {
      if (launcherOpen && !e.target.closest('.launcher') && !e.target.closest('#launcherBtn')) {
        toggleLauncher();
      }
      document.getElementById('contextMenu').classList.remove('active');
      document.getElementById('desktopContextMenu').classList.remove('active');
    });
    
    // Desktop right-click context menu
    document.querySelector('.desktop').addEventListener('contextmenu', e => {
      // Prevent browser default context menu
      e.preventDefault();
      
      // Don't show on specific interactive elements
      const noMenu = e.target.closest('.app-window, .taskbar, .launcher, .context-menu, button, a, input');
      if (noMenu) return;
      
      const menu = document.getElementById('desktopContextMenu');
      menu.style.left = e.clientX + 'px';
      menu.style.top = e.clientY + 'px';
      menu.classList.add('active');
    });
    
    // Wallpaper functions
    const defaultWallpapers = [
      '/images/aurora.jpg',
      '/images/gradient-1.jpg',
      '/images/gradient-2.jpg',
      '/images/space-1.jpg',
      '/images/abstract-1.jpg',
      '/images/nature-1.jpg'
    ];
    
    function openWallpaperPicker() {
      const modal = document.getElementById('wallpaperModal');
      const grid = document.getElementById('wallpaperGrid');
      
      grid.innerHTML = defaultWallpapers.map(wp => `
        <div onclick="setWallpaper('${wp}')" style="height:80px; background:url('${wp}') center/cover; border-radius:8px; cursor:pointer; border:2px solid transparent; transition:all 0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='transparent'"></div>
      `).join('') + `
        <div onclick="setWallpaper('none')" style="height:80px; background:linear-gradient(135deg, #1a1a2e, #0a0a14); border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center; border:2px solid transparent; transition:all 0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='transparent'">
          <span style="color:var(--text-light);">None</span>
        </div>
      `;
      
      modal.style.display = 'flex';
      document.getElementById('desktopContextMenu').classList.remove('active');
    }
    
    function closeWallpaperPicker() {
      document.getElementById('wallpaperModal').style.display = 'none';
    }
    
    function setWallpaper(url) {
      const desktop = document.querySelector('.desktop');
      if (url === 'none') {
        desktop.style.backgroundImage = 'none';
        localStorage.removeItem('desktopWallpaper');
      } else {
        desktop.style.backgroundImage = `url('${url}')`;
        desktop.style.backgroundSize = 'cover';
        desktop.style.backgroundPosition = 'center';
        localStorage.setItem('desktopWallpaper', url);
      }
      closeWallpaperPicker();
    }
    
    function setCustomWallpaper() {
      const url = document.getElementById('customWallpaperUrl').value.trim();
      if (url) setWallpaper(url);
    }
    
    // File upload handling
    let uploadedFileData = null;
    
    document.getElementById('wallpaperFileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          uploadedFileData = { file: document.getElementById('wallpaperFileInput').files[0], dataUrl: e.target.result };
          document.getElementById('uploadPreviewImg').src = e.target.result;
          document.getElementById('uploadPreview').style.display = 'block';
          document.getElementById('uploadStatus').textContent = file.name;
        };
        reader.readAsDataURL(file);
      }
    });
    
    async function applyUploadedWallpaper() {
      if (!uploadedFileData) return;
      
      const token = localStorage.getItem('userToken') || localStorage.getItem('authToken');
      const status = document.getElementById('uploadStatus');
      
      if (!token) {
        // Guest mode - just use the data URL locally
        setWallpaper(uploadedFileData.dataUrl);
        cancelUpload();
        return;
      }
      
      // Upload to server for persistence
      const formData = new FormData();
      formData.append('wallpaper', uploadedFileData.file);
      
      try {
        status.textContent = 'Uploading...';
        const response = await fetch('/api/customization/wallpaper', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });
        
        const data = await response.json();
        if (response.ok) {
          localStorage.setItem('customWallpaper', data.wallpaper_url);
          setWallpaper(data.wallpaper_url);
          cancelUpload();
        } else {
          status.textContent = data.error || 'Upload failed';
          status.style.color = '#ff4444';
        }
      } catch (err) {
        console.error('Wallpaper upload error:', err);
        status.textContent = 'Upload failed';
        status.style.color = '#ff4444';
      }
    }
    
    function cancelUpload() {
      uploadedFileData = null;
      document.getElementById('wallpaperFileInput').value = '';
      document.getElementById('uploadPreview').style.display = 'none';
      document.getElementById('uploadStatus').textContent = '';
      document.getElementById('uploadStatus').style.color = 'var(--text-secondary, #888)';
    }
    
    function refreshDesktop() {
      location.reload();
    }
    
    // Load saved wallpaper
    const savedWallpaper = localStorage.getItem('desktopWallpaper');
    if (savedWallpaper) {
      const desktop = document.querySelector('.desktop');
      desktop.style.backgroundImage = `url('${savedWallpaper}')`;
      desktop.style.backgroundSize = 'cover';
      desktop.style.backgroundPosition = 'center';
    }
    
    document.getElementById('ctxOpen').onclick = () => {
      const app = document.getElementById('contextMenu').dataset.app;
      if (app) openApp(app);
    };
    
    document.getElementById('ctxClose').onclick = () => {
      const app = document.getElementById('contextMenu').dataset.app;
      if (app && openApps.includes(app)) {
        openApps = openApps.filter(a => a !== app);
        if (currentApp === app) closeWindow();
        updateTaskbar();
      }
    };
    
    // Check if user is admin and show/hide admin app accordingly
    let isAdmin = false;
    async function checkAdminStatus() {
      const token = localStorage.getItem('userToken');
      if (!token) return;
      
      try {
        const res = await fetch('/api/admin/check', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        isAdmin = data.isAdmin || false;
        
        // Re-render launcher if it's open
        if (launcherOpen) renderLauncher(currentCat);
      } catch (err) {
        isAdmin = false;
      }
    }
    
    // Override renderLauncher to filter admin app for non-admins
    const originalRenderLauncher = renderLauncher;
    function renderLauncher(cat) {
      const grid = document.getElementById('launcherGrid');
      grid.innerHTML = Object.entries(apps)
        .filter(([k, v]) => {
          // Hide admin app from non-admins
          if (k === 'admin' && !isAdmin) return false;
          return cat === 'all' || v.cat === cat;
        })
        .map(([k, v]) => `
          <div class="launcher-app" data-app="${k}">
            <div class="launcher-app-icon">${v.icon}</div>
            <div class="launcher-app-name">${v.title}</div>
          </div>
        `).join('');
      
      grid.querySelectorAll('.launcher-app').forEach(el => {
        el.onclick = () => openApp(el.dataset.app);
      });
    }
    
    // Init
    const savedUser = localStorage.getItem('username');
    const savedPic = localStorage.getItem('profilePicture');
    if (savedPic) {
      document.getElementById('trayAvatar').innerHTML = `<img src="${savedPic}" alt="">`;
    }
    
    updateClock();
    setInterval(updateClock, 1000);
    
    if (!localStorage.getItem('userToken') && !localStorage.getItem('authToken')) {
      window.location.href = '/lock';
    }
    
    // Check admin status on load
    checkAdminStatus();
    
    // Welcome notification
    setTimeout(() => {
      showNotification('Welcome to NebulaCore', 'Your digital workspace is ready.', '‚ú®', 4000);
    }, 1000);
    
    // Volume Control Functions
    let volumePanelOpen = false;
    const volumeSettings = {
      music: parseInt(localStorage.getItem('vol_music') || '100'),
      video: parseInt(localStorage.getItem('vol_video') || '100'),
      notif: parseInt(localStorage.getItem('vol_notif') || '100'),
      muted: localStorage.getItem('vol_muted') === 'true'
    };
    
    function toggleVolumePanel() {
      volumePanelOpen = !volumePanelOpen;
      const panel = document.getElementById('volumePanel');
      panel.style.display = volumePanelOpen ? 'block' : 'none';
      
      if (volumePanelOpen) {
        document.getElementById('musicVolume').value = volumeSettings.music;
        document.getElementById('videoVolume').value = volumeSettings.video;
        document.getElementById('notifVolume').value = volumeSettings.notif;
        document.getElementById('musicVolVal').textContent = volumeSettings.music + '%';
        document.getElementById('videoVolVal').textContent = volumeSettings.video + '%';
        document.getElementById('notifVolVal').textContent = volumeSettings.notif + '%';
        document.getElementById('muteAll').checked = volumeSettings.muted;
      }
    }
    
    function updateVolume(type, value) {
      volumeSettings[type] = parseInt(value);
      localStorage.setItem('vol_' + type, value);
      document.getElementById(type + 'VolVal').textContent = value + '%';
      
      // Broadcast volume change to iframe apps
      const frame = document.getElementById('appFrame');
      if (frame && frame.contentWindow) {
        frame.contentWindow.postMessage({ type: 'volumeChange', channel: type, value: parseInt(value) }, '*');
      }
    }
    
    function toggleMuteAll() {
      volumeSettings.muted = document.getElementById('muteAll').checked;
      localStorage.setItem('vol_muted', volumeSettings.muted);
      
      const frame = document.getElementById('appFrame');
      if (frame && frame.contentWindow) {
        frame.contentWindow.postMessage({ type: 'muteAll', muted: volumeSettings.muted }, '*');
      }
    }
    
    // Close volume panel when clicking outside
    document.addEventListener('click', e => {
      if (volumePanelOpen && !e.target.closest('#volumePanel') && !e.target.closest('.tray-item')) {
        volumePanelOpen = false;
        document.getElementById('volumePanel').style.display = 'none';
      }
    });
    
    // Listen for chat notifications from iframe
    window.addEventListener('message', e => {
      if (e.data && e.data.type === 'chatNotification') {
        showNotification(e.data.title, e.data.body, e.data.icon || 'üí¨', 5000);
      }
    });
  </script>
  <script src="/js/security.js"></script>
  <script src="/js/stealth-mode.js"></script>
  <script>if (typeof StealthMode !== 'undefined') StealthMode.init();</script>
</body>
</html>
