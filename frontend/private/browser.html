<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Browser - NebulaCore</title>
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/private-theme.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg, #0C0C0C);
      color: var(--text, #fff);
      height: 100vh;
      display: flex;
      overflow: hidden;
    }

    .sidebar {
      width: 200px;
      background: var(--bg-secondary, #111);
      border-right: 1px solid var(--glass-border, #222);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 12px 16px;
      font-size: 12px;
      color: var(--text-secondary, #888);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .new-tab-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      color: var(--text-secondary, #aaa);
      cursor: pointer;
      transition: all 0.15s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-size: 13px;
    }

    .new-tab-btn:hover {
      background: var(--card-hover, #1a1a1a);
      color: var(--text, #fff);
    }

    .tabs-list {
      flex: 1;
      overflow-y: auto;
    }

    .tab-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      cursor: pointer;
      transition: all 0.15s;
      border-left: 3px solid transparent;
      position: relative;
    }

    .tab-item:hover {
      background: var(--card-hover, #1a1a1a);
    }

    .tab-item.active {
      background: var(--card-hover, #1a1a1a);
      border-left-color: var(--primary, #6366f1);
    }

    .tab-favicon {
      width: 16px;
      height: 16px;
      border-radius: 2px;
      object-fit: contain;
      background: var(--glass-bg, #333);
    }

    .tab-title {
      flex: 1;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text, #fff);
    }

    .tab-close {
      opacity: 0;
      width: 18px;
      height: 18px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      color: var(--text-secondary, #888);
      cursor: pointer;
      font-size: 14px;
      transition: all 0.15s;
    }

    .tab-item:hover .tab-close {
      opacity: 1;
    }

    .tab-close:hover {
      background: var(--glass-bg, #333);
      color: var(--text, #fff);
    }

    .engine-section {
      padding: 12px 16px;
      border-top: 1px solid var(--glass-border, #222);
    }

    .engine-label {
      font-size: 11px;
      color: var(--text-muted, #666);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .engine-select {
      width: 100%;
      padding: 8px 10px;
      background: var(--card, #1a1a1a);
      border: 1px solid var(--glass-border, #333);
      border-radius: 6px;
      color: var(--text, #fff);
      font-size: 12px;
      cursor: pointer;
      outline: none;
    }

    .engine-select:hover {
      border-color: var(--text-muted, #444);
    }

    .engine-select:focus {
      border-color: var(--primary, #6366f1);
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .toolbar {
      height: 48px;
      background: var(--bg-secondary, #111);
      border-bottom: 1px solid var(--glass-border, #222);
      display: flex;
      align-items: center;
      padding: 0 12px;
      gap: 8px;
      flex-shrink: 0;
    }

    .nav-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: none;
      background: transparent;
      color: var(--text-secondary, #888);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      font-size: 16px;
    }

    .nav-btn:hover {
      background: var(--card-hover, #222);
      color: var(--text, #fff);
    }

    .nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .url-bar {
      flex: 1;
      height: 32px;
      background: var(--card, #1a1a1a);
      border: 1px solid var(--glass-border, #333);
      border-radius: 8px;
      display: flex;
      align-items: center;
      padding: 0 12px;
      gap: 8px;
    }

    .url-bar:focus-within {
      border-color: var(--primary, #6366f1);
      box-shadow: var(--glow-primary, 0 0 10px rgba(99, 102, 241, 0.3));
    }

    .url-icon {
      color: var(--text-muted, #666);
      font-size: 14px;
    }

    .url-input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text, #fff);
      font-size: 13px;
      outline: none;
    }

    .url-input::placeholder {
      color: var(--text-muted, #555);
    }

    .toolbar-actions {
      display: flex;
      gap: 4px;
    }

    .theme-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: none;
      background: transparent;
      color: var(--text-secondary, #888);
      cursor: pointer;
      transition: all 0.15s;
      font-size: 16px;
    }

    .theme-btn:hover {
      background: var(--primary, #6366f1);
      color: var(--bg, #fff);
    }

    .browser-frame {
      flex: 1;
      background: var(--bg, #000);
      position: relative;
    }

    .browser-frame iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .empty-state {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-muted, #555);
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .loading-overlay {
      position: absolute;
      inset: 0;
      background: var(--bg, #000);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      transition: opacity 0.3s;
    }

    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loading-frame {
      max-width: 200px;
      image-rendering: pixelated;
      position: absolute;
    }

    .loading-frame.closed {
      opacity: 1;
      transition: opacity 0.3s;
    }

    .loading-frame.loading {
      opacity: 0;
      transition: opacity 0.3s;
    }

    .loading-overlay.phase2 .loading-frame.closed {
      opacity: 0;
    }

    .loading-overlay.phase2 .loading-frame.loading {
      opacity: 1;
      animation: pulse-loading 1.5s ease-in-out infinite;
    }

    @keyframes pulse-loading {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    .home-btn {
      font-size: 18px;
    }

    .status-indicator {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-left: 8px;
      white-space: nowrap;
    }

    .status-indicator.ready {
      background: rgba(34, 197, 94, 0.2);
      color: var(--success, #22c55e);
    }

    .status-indicator.loading {
      background: rgba(234, 179, 8, 0.2);
      color: var(--warning, #eab308);
    }

    .status-indicator.error {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger, #ef4444);
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">Tabs</div>
    <button class="new-tab-btn" onclick="newTab()">
      <span>+</span> New Tab
    </button>
    <div class="tabs-list" id="tabsList"></div>
    
    <div class="engine-section">
      <div class="engine-label">Proxy Engine</div>
      <select class="engine-select" id="engineSelect" onchange="switchEngine()">
        <option value="uv">Ultraviolet</option>
        <option value="server">Server Proxy</option>
      </select>
    </div>
  </div>

  <div class="main-content">
    <div class="toolbar">
      <button class="nav-btn" onclick="goBack()" title="Back">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>
      <button class="nav-btn" onclick="goForward()" title="Forward">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M9 18l6-6-6-6"/>
        </svg>
      </button>
      <button class="nav-btn" onclick="refresh()" title="Refresh">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M4 4v5h5M20 20v-5h-5"/>
          <path d="M20.5 9A9 9 0 0 0 5.6 5.6L4 7m16 10l-1.6-1.4A9 9 0 0 1 3.5 15"/>
        </svg>
      </button>
      
      <div class="url-bar">
        <svg class="url-icon" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
        </svg>
        <input type="text" class="url-input" id="urlInput" placeholder="Search or enter URL..." onkeydown="handleUrlInput(event)">
      </div>

      <span class="status-indicator ready" id="swStatus">Ready</span>

      <div class="toolbar-actions">
        <button class="theme-btn" onclick="openThemeModal()" title="Change Theme">
          ðŸŽ¨
        </button>
        <button class="nav-btn home-btn" onclick="goHome()" title="Home">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M3 12l9-9 9 9M5 10v10a1 1 0 001 1h3m10-11v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="browser-frame" id="browserFrame">
      <div class="loading-overlay hidden" id="loadingOverlay">
        <img src="/assets/proxy-frame.png" class="loading-frame closed" alt="">
        <img src="/assets/proxy-loading.png" class="loading-frame loading" alt="">
      </div>
      <div class="empty-state" id="emptyState">
        <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
          <path d="M12 21a9 9 0 100-18 9 9 0 000 18z"/>
          <path d="M3.6 9h16.8M3.6 15h16.8"/>
          <path d="M12 3a15 15 0 014 9 15 15 0 01-4 9 15 15 0 01-4-9 15 15 0 014-9z"/>
        </svg>
        <p>Enter a URL or search to get started</p>
      </div>
    </div>
  </div>

  <script>
    let tabs = [];
    let activeTabId = null;
    let currentEngine = localStorage.getItem('proxyEngine') || 'uv';
    let swStatus = { uv: false };
    let uvLoadPromise = null;
    let bareMuxPromise = null;
    const scriptPromises = {};

    async function loadScript(src) {
      if (scriptPromises[src]) return scriptPromises[src];
      
      scriptPromises[src] = new Promise((resolve, reject) => {
        const existing = document.querySelector(`script[src="${src}"]`);
        if (existing) {
          if (existing.dataset.loaded === 'true') {
            resolve(true);
          } else {
            existing.addEventListener('load', () => resolve(true));
            existing.addEventListener('error', () => reject(new Error('Failed to load ' + src)));
          }
          return;
        }
        const script = document.createElement('script');
        script.src = src;
        script.onload = () => { script.dataset.loaded = 'true'; resolve(true); };
        script.onerror = () => { delete scriptPromises[src]; reject(new Error('Failed to load ' + src)); };
        document.head.appendChild(script);
      });
      
      return scriptPromises[src];
    }

    async function initBareMux() {
      if (bareMuxPromise) return bareMuxPromise;
      
      bareMuxPromise = (async () => {
        await loadScript('/baremux/index.js');
        if (typeof BareMux !== 'undefined' && BareMux.BareMuxConnection) {
          const conn = new BareMux.BareMuxConnection('/baremux/worker.js');
          const bareUrl = new URL('/bare/', location.origin).href;
          await conn.setTransport('/bareasmodule/index.mjs', [bareUrl]);
          console.log('BareMux transport configured with:', bareUrl);
        }
      })();
      
      return bareMuxPromise;
    }

    async function loadUVBundle() {
      if (uvLoadPromise) return uvLoadPromise;
      
      uvLoadPromise = (async () => {
        try {
          await initBareMux();
          await loadScript('/uv/uv.bundle.js');
          await loadScript('/uv/uv.config.js');
          return true;
        } catch (err) {
          console.error('Failed to load UV bundle:', err);
          uvLoadPromise = null;
          return false;
        }
      })();
      
      return uvLoadPromise;
    }

    async function registerServiceWorkers() {
      const status = document.getElementById('swStatus');
      
      if (!('serviceWorker' in navigator)) {
        status.textContent = 'Using Server';
        status.className = 'status-indicator ready';
        currentEngine = 'server';
        document.getElementById('engineSelect').value = 'server';
        return;
      }

      status.textContent = 'Loading UV...';
      status.className = 'status-indicator loading';

      const loaded = await loadUVBundle();
      if (!loaded) {
        status.textContent = 'Using Server';
        status.className = 'status-indicator ready';
        currentEngine = 'server';
        return;
      }

      try {
        const uvReg = await navigator.serviceWorker.register('/uv/sw.js', { scope: '/service/' });
        console.log('UV service worker registered:', uvReg.scope);
        swStatus.uv = true;
        status.textContent = 'UV Ready';
        status.className = 'status-indicator ready';
      } catch (err) {
        console.error('UV SW registration failed:', err);
        status.textContent = 'Using Server';
        status.className = 'status-indicator ready';
        currentEngine = 'server';
      }
    }

    function updateStatus() {
      const status = document.getElementById('swStatus');
      
      if (currentEngine === 'uv') {
        if (swStatus.uv) {
          status.textContent = 'UV Ready';
          status.className = 'status-indicator ready';
        } else {
          status.textContent = 'Loading...';
          status.className = 'status-indicator loading';
        }
      } else {
        status.textContent = 'Server Ready';
        status.className = 'status-indicator ready';
      }
    }

    function switchEngine() {
      const select = document.getElementById('engineSelect');
      currentEngine = select.value;
      localStorage.setItem('proxyEngine', currentEngine);
      
      if (currentEngine === 'uv' && !swStatus.uv) {
        registerServiceWorkers();
      } else {
        updateStatus();
      }
      
      const tab = tabs.find(t => t.id === activeTabId);
      if (tab && tab.url) {
        loadUrl(tab.url, false);
      }
    }

    function generateId() {
      return Math.random().toString(36).substr(2, 9);
    }

    async function ensureUVReady() {
      if (currentEngine !== 'uv') return true;
      if (swStatus.uv && typeof self.__uv$config !== 'undefined') return true;
      
      const status = document.getElementById('swStatus');
      status.textContent = 'Loading UV...';
      status.className = 'status-indicator loading';
      
      await loadUVBundle();
      
      if (!swStatus.uv) {
        try {
          const uvReg = await navigator.serviceWorker.register('/uv/sw.js', { scope: '/service/' });
          console.log('UV service worker registered:', uvReg.scope);
          swStatus.uv = true;
        } catch (err) {
          console.error('UV SW registration failed:', err);
          return false;
        }
      }
      
      status.textContent = 'UV Ready';
      status.className = 'status-indicator ready';
      return true;
    }

    async function getProxyUrl(url) {
      if (currentEngine === 'uv' && swStatus.uv && typeof self.__uv$config !== 'undefined') {
        const encoded = self.__uv$config.encodeUrl(url);
        console.log('UV encoding:', url, '->', self.__uv$config.prefix + encoded);
        return self.__uv$config.prefix + encoded;
      }
      console.log('Using server proxy for:', url);
      return '/api/proxy/fetch?url=' + encodeURIComponent(url);
    }

    function getFavicon(url) {
      try {
        const u = new URL(url);
        return `https://www.google.com/s2/favicons?domain=${u.hostname}&sz=32`;
      } catch {
        return '';
      }
    }

    function getTitle(url) {
      try {
        const u = new URL(url);
        return u.hostname.replace('www.', '');
      } catch {
        return 'New Tab';
      }
    }

    function renderTabs() {
      const list = document.getElementById('tabsList');
      list.innerHTML = tabs.map(tab => `
        <div class="tab-item ${tab.id === activeTabId ? 'active' : ''}" onclick="switchTab('${tab.id}')">
          <img class="tab-favicon" src="${tab.favicon || ''}" onerror="this.style.display='none'">
          <span class="tab-title">${tab.title}</span>
          <button class="tab-close" onclick="event.stopPropagation(); closeTab('${tab.id}')">&times;</button>
        </div>
      `).join('');
    }

    function newTab() {
      const id = generateId();
      const tab = {
        id,
        url: '',
        title: 'New Tab',
        favicon: ''
      };
      tabs.push(tab);
      switchTab(id);
      document.getElementById('urlInput').focus();
    }

    function switchTab(id) {
      activeTabId = id;
      const tab = tabs.find(t => t.id === id);
      
      if (tab && tab.url) {
        document.getElementById('urlInput').value = tab.title || getTitle(tab.url);
        loadUrl(tab.url, false);
      } else {
        document.getElementById('urlInput').value = '';
        showEmptyState();
      }
      
      renderTabs();
    }

    function closeTab(id) {
      const index = tabs.findIndex(t => t.id === id);
      if (index === -1) return;
      
      tabs.splice(index, 1);
      
      if (tabs.length === 0) {
        newTab();
      } else if (activeTabId === id) {
        const newIndex = Math.min(index, tabs.length - 1);
        switchTab(tabs[newIndex].id);
      } else {
        renderTabs();
      }
    }

    function showEmptyState() {
      const frame = document.getElementById('browserFrame');
      const existing = frame.querySelector('iframe');
      if (existing) existing.remove();
      document.getElementById('emptyState').style.display = 'flex';
    }

    async function handleUrlInput(e) {
      if (e.key === 'Enter') {
        const input = e.target.value.trim();
        if (!input) return;

        let url;
        if (input.match(/^https?:\/\//)) {
          url = input;
        } else if (input.match(/^[\w-]+\.[a-z]{2,}/i)) {
          url = 'https://' + input;
        } else {
          url = 'https://duckduckgo.com/?q=' + encodeURIComponent(input);
        }

        await loadUrl(url, true);
      }
    }

    async function loadUrl(url, updateTab = true) {
      const frame = document.getElementById('browserFrame');
      const loading = document.getElementById('loadingOverlay');
      const emptyState = document.getElementById('emptyState');

      emptyState.style.display = 'none';
      loading.classList.remove('hidden', 'phase2');

      setTimeout(() => {
        loading.classList.add('phase2');
      }, 300);

      // Ensure proxy is ready if using UV engine
      if (currentEngine === 'uv') {
        await ensureUVReady();
      }

      let iframe = frame.querySelector('iframe');
      if (!iframe) {
        iframe = document.createElement('iframe');
        iframe.setAttribute('allowfullscreen', 'true');
        iframe.setAttribute('allow', 'fullscreen; autoplay; encrypted-media');
        iframe.style.border = 'none';
        frame.appendChild(iframe);
      }

      const proxyUrl = await getProxyUrl(url);
      console.log('Engine:', currentEngine, '| UV Ready:', swStatus.uv, '| Config:', typeof self.__uv$config);
      console.log('Loading:', url, '-> Proxy:', proxyUrl);
      
      iframe.src = proxyUrl;
      
      iframe.onload = () => {
        console.log('Iframe loaded');
        loading.classList.add('hidden');
        loading.classList.remove('phase2');
      };
      
      setTimeout(() => {
        if (!loading.classList.contains('hidden')) {
          loading.classList.add('hidden');
          loading.classList.remove('phase2');
        }
      }, 15000);

      if (updateTab && activeTabId) {
        const tab = tabs.find(t => t.id === activeTabId);
        if (tab) {
          tab.url = url;
          tab.title = getTitle(url);
          tab.favicon = getFavicon(url);
          document.getElementById('urlInput').value = getTitle(url);
          renderTabs();
        }
      }
    }

    function goBack() {
      const iframe = document.querySelector('#browserFrame iframe');
      if (iframe) {
        try { iframe.contentWindow.history.back(); } catch(e) {}
      }
    }

    function goForward() {
      const iframe = document.querySelector('#browserFrame iframe');
      if (iframe) {
        try { iframe.contentWindow.history.forward(); } catch(e) {}
      }
    }

    function refresh() {
      const tab = tabs.find(t => t.id === activeTabId);
      if (tab && tab.url) {
        loadUrl(tab.url, false);
      }
    }

    function goHome() {
      window.location.href = '/proxy';
    }

    async function preloadAllProxies() {
      await loadUVBundle().catch(e => console.log('UV preload failed:', e));
    }

    async function init() {
      document.getElementById('engineSelect').value = currentEngine;
      
      const status = document.getElementById('swStatus');
      
      newTab();

      const params = new URLSearchParams(window.location.search);
      const initialUrl = params.get('url') || params.get('q');

      if (initialUrl) {
        let url = initialUrl;
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
          url = 'https://' + url;
        }
        
        const tab = tabs.find(t => t.id === activeTabId);
        if (tab) {
          tab.url = url;
          tab.title = getTitle(url);
          tab.favicon = getFavicon(url);
          document.getElementById('urlInput').value = getTitle(url);
          renderTabs();
        }
      }

      preloadAllProxies();

      if (currentEngine === 'uv') {
        await ensureUVReady();
      } else {
        status.textContent = 'Server Ready';
        status.className = 'status-indicator ready';
      }
      
      if (initialUrl) {
        loadUrl(initialUrl.startsWith('http') ? initialUrl : 'https://' + initialUrl, false);
      }
    }

    init();
  </script>
  <script src="/js/themes.js"></script>
  <script src="/js/mobile-nav.js"></script>
  <script>
    // Initialize theme on page load
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof initTheme === 'function') {
        initTheme();
      }
    });
  </script>
</body>
</html>
