<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NebulaCore</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', 'Inter', -apple-system, sans-serif;
      background: #000;
      color: #fff;
      min-height: 100vh;
      overflow: hidden;
    }
    
    .lock-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: url('/images/aurora.jpg');
      background-size: cover;
      background-position: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    
    .lock-time {
      font-size: 96px;
      font-weight: 400;
      text-shadow: 0 2px 20px rgba(0,0,0,0.3);
      margin-bottom: 8px;
      letter-spacing: -2px;
    }
    
    .lock-date {
      font-size: 18px;
      font-weight: 400;
      text-shadow: 0 1px 10px rgba(0,0,0,0.3);
      opacity: 0.95;
    }
    
    .lock-hint {
      position: fixed;
      bottom: 60px;
      font-size: 14px;
      opacity: 0.8;
    }
    
    .lock-status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 14px;
    }
    
    .lock-status-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    /* Login Screen */
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: url('/images/aurora.jpg');
      background-size: cover;
      background-position: center;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .login-screen.active {
      display: flex;
    }
    
    .login-avatar {
      width: 160px;
      height: 160px;
      border-radius: 50%;
      background: linear-gradient(135deg, #0078d4, #00bcf2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 72px;
      margin-bottom: 20px;
      box-shadow: 0 4px 30px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .login-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .login-username {
      font-size: 32px;
      font-weight: 400;
      margin-bottom: 24px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    .login-password-container {
      position: relative;
      width: 280px;
    }
    
    .login-password {
      width: 100%;
      padding: 12px 50px 12px 16px;
      font-size: 14px;
      background: rgba(0,0,0,0.4);
      border: none;
      border-radius: 4px;
      color: #fff;
      outline: none;
    }
    
    .login-password::placeholder {
      color: rgba(255,255,255,0.6);
    }
    
    .login-password:focus {
      background: rgba(0,0,0,0.5);
    }
    
    .login-submit {
      position: absolute;
      right: 4px;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      background: transparent;
      border: none;
      border-radius: 4px;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .login-submit:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .login-error {
      margin-top: 12px;
      color: #ff6b6b;
      font-size: 13px;
      min-height: 20px;
    }
    
    .login-options {
      position: fixed;
      bottom: 20px;
      display: flex;
      gap: 24px;
    }
    
    .login-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px;
      border-radius: 4px;
      cursor: pointer;
      min-width: 80px;
    }
    
    .login-option:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .login-option-icon {
      font-size: 24px;
      margin-bottom: 6px;
    }
    
    .login-option-label {
      font-size: 11px;
      opacity: 0.9;
    }
    
    .back-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 4px;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
    }
    
    .back-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .back-btn.visible {
      display: flex;
    }
  </style>
</head>
<body>
  <button class="back-btn" id="backBtn" onclick="showLockScreen()">&#8592;</button>
  
  <div class="lock-screen" id="lockScreen" onclick="showLoginScreen()">
    <div class="lock-time" id="lockTime">12:00</div>
    <div class="lock-date" id="lockDate">Wednesday, December 17</div>
    <div class="lock-hint">Click anywhere to unlock</div>
    <div class="lock-status">
      <div class="lock-status-item">&#128246;</div>
      <div class="lock-status-item">&#128267;</div>
    </div>
  </div>
  
  <div class="login-screen" id="loginScreen">
    <div class="login-avatar" id="loginAvatar">&#128100;</div>
    <div class="login-username" id="loginUsername">User</div>
    <div class="login-password-container">
      <input type="password" class="login-password" id="loginPassword" placeholder="Password" autocomplete="current-password">
      <button class="login-submit" onclick="attemptLogin()">&#8594;</button>
    </div>
    <div class="login-error" id="loginError"></div>
    
    <div class="login-options">
      <div class="login-option" onclick="switchUser()">
        <div class="login-option-icon">&#128100;</div>
        <div class="login-option-label">Other user</div>
      </div>
      <div class="login-option" onclick="continueAsGuest()">
        <div class="login-option-icon">&#128683;</div>
        <div class="login-option-label">Guest mode</div>
      </div>
    </div>
  </div>

  <script>
    function updateTime() {
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes().toString().padStart(2, '0');
      
      document.getElementById('lockTime').textContent = `${hours}:${minutes}`;
      
      const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      document.getElementById('lockDate').textContent = `${days[now.getDay()]}, ${months[now.getMonth()]} ${now.getDate()}`;
    }
    
    function showLockScreen() {
      document.getElementById('lockScreen').style.display = 'flex';
      document.getElementById('loginScreen').classList.remove('active');
      document.getElementById('backBtn').classList.remove('visible');
    }
    
    function showLoginScreen() {
      document.getElementById('lockScreen').style.display = 'none';
      document.getElementById('loginScreen').classList.add('active');
      document.getElementById('backBtn').classList.add('visible');
      document.getElementById('loginPassword').focus();
      
      const savedUser = localStorage.getItem('username');
      const savedPic = localStorage.getItem('profilePicture');
      
      if (savedUser) {
        document.getElementById('loginUsername').textContent = savedUser;
      }
      if (savedPic) {
        document.getElementById('loginAvatar').innerHTML = `<img src="${savedPic}" alt="">`;
      }
    }
    
    async function attemptLogin() {
      const username = localStorage.getItem('username');
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('loginError');
      
      if (!username) {
        window.location.href = '/auth';
        return;
      }
      
      if (!password) {
        errorEl.textContent = 'Please enter your password';
        return;
      }
      
      try {
        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ username, password })
        });
        
        const data = await res.json();
        
        if (data.token) {
          localStorage.setItem('userToken', data.token);
          localStorage.setItem('userId', data.user.id);
          localStorage.setItem('username', data.user.username);
          if (data.user.profile_picture) {
            localStorage.setItem('profilePicture', data.user.profile_picture);
          }
          window.location.href = '/private/desktop.html';
        } else {
          errorEl.textContent = data.error || 'Invalid password';
        }
      } catch (err) {
        errorEl.textContent = 'Connection error. Please try again.';
      }
    }
    
    document.getElementById('loginPassword').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') attemptLogin();
    });
    
    function switchUser() {
      // Clear stored user and show username input
      localStorage.removeItem('userToken');
      localStorage.removeItem('userId');
      localStorage.removeItem('username');
      localStorage.removeItem('profilePicture');
      document.getElementById('loginUsername').textContent = 'Enter username';
      document.getElementById('loginAvatar').innerHTML = '&#128100;';
      
      // Replace password input with username input
      const container = document.querySelector('.login-password-container');
      container.innerHTML = `
        <input type="text" class="login-password" id="usernameInput" placeholder="Username" autocomplete="username">
        <button class="login-submit" onclick="setUsername()">&#8594;</button>
      `;
      document.getElementById('usernameInput').focus();
      document.getElementById('usernameInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') setUsername();
      });
    }
    
    function setUsername() {
      const usernameInput = document.getElementById('usernameInput');
      const username = usernameInput.value.trim();
      if (!username) {
        document.getElementById('loginError').textContent = 'Please enter a username';
        return;
      }
      localStorage.setItem('username', username);
      document.getElementById('loginUsername').textContent = username;
      
      // Switch back to password input
      const container = document.querySelector('.login-password-container');
      container.innerHTML = `
        <input type="password" class="login-password" id="loginPassword" placeholder="Password" autocomplete="current-password">
        <button class="login-submit" onclick="attemptLogin()">&#8594;</button>
      `;
      document.getElementById('loginPassword').focus();
      document.getElementById('loginPassword').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') attemptLogin();
      });
      document.getElementById('loginError').textContent = '';
    }
    
    async function continueAsGuest() {
      try {
        const res = await fetch('/api/auth/guest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });
        const data = await res.json();
        if (data.token) {
          localStorage.setItem('userToken', data.token);
          localStorage.setItem('userId', data.user.id);
          localStorage.setItem('username', data.user.username);
          localStorage.setItem('isGuest', 'true');
          window.location.href = '/private/desktop.html';
        }
      } catch (err) {
        document.getElementById('loginError').textContent = 'Could not start guest session';
      }
    }
    
    // Check if coming from fake Staff Portal - require fresh login
    const fromStaffPortal = document.referrer.includes('/classlink');
    
    if (fromStaffPortal) {
      // Clear any existing session to require fresh login
      localStorage.removeItem('userToken');
      localStorage.removeItem('userId');
      // Keep username for convenience but require password
    }
    
    const token = localStorage.getItem('userToken');
    const username = localStorage.getItem('username');
    
    if (token && username && !fromStaffPortal) {
      window.location.href = '/private/desktop.html';
    } else if (username) {
      showLoginScreen();
    }
    
    updateTime();
    setInterval(updateTime, 1000);
  </script>
  <script src="/js/security.js"></script>
</body>
</html>
