<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Games - NebulaCore</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="shortcut icon" type="image/png" href="/favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/transitions.css">
  <link rel="stylesheet" href="/css/private-theme.css">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
    }

    .page-container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--accent);
      flex-wrap: wrap;
      gap: 15px;
    }

    .page-header h1 {
      font-size: 32px;
      margin: 0;
      flex: 1;
      min-width: 200px;
    }

    .search-container {
      display: flex;
      gap: 10px;
      align-items: center;
      flex: 1;
      min-width: 250px;
    }

    #searchInput {
      flex: 1;
      padding: 12px 16px;
      background: var(--card);
      border: 2px solid var(--accent);
      border-radius: 8px;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      transition: all 0.2s;
    }

    #searchInput:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }

    #searchInput::placeholder {
      color: var(--text-light);
    }

    .search-clear {
      padding: 8px 12px;
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--accent);
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      transition: all 0.2s;
      display: none;
    }

    .search-clear.show {
      display: block;
    }

    .search-clear:hover {
      background: var(--primary);
      color: var(--bg);
    }

    .search-results {
      font-size: 13px;
      color: var(--text-light);
      margin-bottom: 10px;
    }

    .no-results {
      text-align: center;
      color: var(--text-light);
      padding: 60px 20px;
      font-size: 16px;
    }

    .no-results-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .back-btn {
      padding: 10px 20px;
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }

    .back-btn:hover {
      background: var(--primary);
      color: var(--bg);
    }

    .theme-btn {
      padding: 10px 16px;
      background: var(--glass-bg, var(--card));
      border: 1px solid var(--glass-border, var(--accent));
      border-radius: 8px;
      color: var(--text);
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .theme-btn:hover {
      background: var(--primary);
      border-color: var(--primary);
      transform: scale(1.05);
    }

    .games-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }

    .game-card {
      background: var(--card);
      border: 2px solid var(--accent);
      border-radius: 14px;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
    }

    .game-card-content {
      cursor: pointer;
    }

    .game-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 6px;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .game-card:hover .game-actions {
      opacity: 1;
    }

    .game-action-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(0, 0, 0, 0.7);
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .game-action-btn:hover {
      transform: scale(1.15);
      background: rgba(0, 0, 0, 0.9);
    }

    .game-action-btn.active {
      background: var(--primary);
    }

    .pin-btn.active {
      background: #f39c12;
    }

    .like-btn.active {
      background: #e74c3c;
    }

    .category-btn.special {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: white;
      border-color: transparent;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      display: flex;
      flex-direction: column;
    }

    .game-card:hover {
      transform: translateY(-10px);
      border-color: var(--primary);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
    }

    .game-thumbnail {
      width: 100%;
      height: 200px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 80px;
      color: var(--bg);
    }

    .game-info {
      padding: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .game-name {
      font-size: 18px;
      font-weight: 700;
      margin: 0 0 8px 0;
    }

    .game-description {
      font-size: 13px;
      color: var(--text-light);
      margin: 0 0 15px 0;
      flex: 1;
    }

    .play-btn {
      padding: 10px 16px;
      background: var(--primary);
      color: var(--bg);
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }

    .play-btn:hover {
      opacity: 0.9;
      transform: scale(1.02);
    }

    .loading {
      text-align: center;
      color: var(--text-light);
      padding: 40px;
      font-size: 14px;
    }

    .error {
      background: var(--accent);
      border: 2px solid #e74c3c;
      border-radius: 12px;
      padding: 20px;
      color: #e74c3c;
      text-align: center;
      margin-bottom: 20px;
    }

    /* Game Viewer Modal */
    .game-viewer {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      z-index: 10000;
      flex-direction: column;
    }

    .game-viewer.active {
      display: flex;
    }

    .game-viewer.fullscreen-mode .game-viewer-header {
      display: none;
    }

    .game-viewer.fullscreen-mode .game-viewer-content {
      height: 100%;
    }

    .game-viewer-header {
      background: var(--card);
      border-bottom: 2px solid var(--accent);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
    }

    .game-viewer-title {
      font-size: 20px;
      font-weight: 700;
      flex: 1;
      margin: 0;
    }

    .game-viewer-buttons {
      display: flex;
      gap: 10px;
    }

    .game-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }

    .fullscreen-btn {
      background: #4B9BFF;
      color: white;
    }

    .fullscreen-btn:hover {
      background: #3A7FD4;
      transform: scale(1.05);
    }

    .exit-btn {
      background: #FF6B6B;
      color: white;
    }

    .exit-btn:hover {
      background: #E74C3C;
      transform: scale(1.05);
    }

    .game-viewer-content {
      flex: 1;
      overflow: hidden;
    }

    #gameFrame {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Fullscreen exit hint */
    .fullscreen-hint {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 24px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: 500;
      z-index: 10001;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }

    .fullscreen-hint.show {
      opacity: 1;
    }

    .fullscreen-hint kbd {
      background: rgba(255, 255, 255, 0.2);
      padding: 4px 10px;
      border-radius: 6px;
      margin: 0 4px;
      font-family: monospace;
      font-size: 15px;
    }

    /* Category Filters */
    .category-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 25px;
      padding: 15px;
      background: var(--card);
      border-radius: 12px;
      border: 1px solid var(--accent);
    }

    .category-btn {
      padding: 8px 16px;
      background: transparent;
      border: 2px solid var(--accent);
      border-radius: 20px;
      color: var(--text);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .category-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .category-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: var(--bg);
    }

    .category-count {
      font-size: 11px;
      opacity: 0.7;
      margin-left: 4px;
    }

    /* Recently Played Section */
    .recently-played {
      margin-bottom: 30px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .recently-played-grid {
      display: flex;
      gap: 15px;
      overflow-x: auto;
      padding-bottom: 10px;
      scrollbar-width: thin;
    }

    .recently-played-grid::-webkit-scrollbar {
      height: 6px;
    }

    .recently-played-grid::-webkit-scrollbar-track {
      background: var(--card);
      border-radius: 3px;
    }

    .recently-played-grid::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 3px;
    }

    .recent-game-card {
      min-width: 180px;
      background: var(--card);
      border: 2px solid var(--accent);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
    }

    .recent-game-card:hover {
      border-color: var(--primary);
      transform: translateY(-5px);
    }

    .recent-game-thumb {
      height: 100px;
      background: linear-gradient(135deg, var(--primary), var(--secondary, #ff6b6b));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
    }

    .recent-game-info {
      padding: 12px;
    }

    .recent-game-name {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .recent-game-time {
      font-size: 11px;
      color: var(--text-light);
    }

    /* Thumbnail images */
    .game-thumbnail-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .game-thumbnail.has-image {
      padding: 0;
      font-size: 0;
    }

    /* Star Rating */
    .rating-section {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-right: 15px;
      padding: 6px 12px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
    }

    .rating-label {
      font-size: 13px;
      color: var(--text-light);
    }

    .star-rating {
      display: flex;
      gap: 2px;
    }

    .star {
      font-size: 20px;
      cursor: pointer;
      color: #444;
      transition: all 0.15s;
    }

    .star:hover,
    .star.hovered {
      color: #ffd700;
      transform: scale(1.2);
    }

    .star.active {
      color: #ffd700;
    }

    .avg-rating {
      font-size: 13px;
      color: var(--text-light);
      margin-left: 5px;
    }

    /* Speedrun Timer */
    .speedrun-section {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-right: 15px;
      padding: 6px 12px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
    }

    .timer-display {
      font-family: 'Courier New', monospace;
      font-size: 18px;
      font-weight: bold;
      color: #00ff88;
      min-width: 100px;
      text-align: center;
    }

    .timer-display.running {
      color: #ffcc00;
    }

    .timer-display.stopped {
      color: #ff6b6b;
    }

    .timer-btn {
      padding: 5px 12px;
      border: none;
      border-radius: 5px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .timer-btn.start-btn {
      background: #00ff88;
      color: #000;
    }

    .timer-btn.start-btn.running {
      background: #ffcc00;
    }

    .timer-btn.reset-btn {
      background: #666;
      color: white;
    }

    .timer-btn.submit-btn {
      background: var(--accent);
      color: white;
    }

    .timer-btn:hover {
      transform: scale(1.05);
    }

    .leaderboard-btn {
      padding: 8px 12px !important;
      font-size: 16px !important;
    }

    /* Leaderboard Modal */
    .leaderboard-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 10001;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .leaderboard-modal.active {
      display: flex;
    }

    .leaderboard-content {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 25px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .leaderboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .leaderboard-header h3 {
      margin: 0;
      color: var(--accent);
    }

    .leaderboard-close {
      background: none;
      border: none;
      color: var(--text);
      font-size: 24px;
      cursor: pointer;
    }

    .leaderboard-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .leaderboard-tab {
      flex: 1;
      padding: 10px;
      border: 2px solid var(--border);
      background: transparent;
      color: var(--text);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .leaderboard-tab.active {
      background: var(--accent);
      border-color: var(--accent);
    }

    .leaderboard-entry {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .leaderboard-rank {
      font-size: 18px;
      font-weight: bold;
      width: 30px;
      text-align: center;
    }

    .leaderboard-rank.gold { color: #ffd700; }
    .leaderboard-rank.silver { color: #c0c0c0; }
    .leaderboard-rank.bronze { color: #cd7f32; }

    .leaderboard-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
    }

    .leaderboard-info {
      flex: 1;
    }

    .leaderboard-name {
      font-weight: 600;
    }

    .leaderboard-score {
      font-size: 13px;
      color: var(--text-secondary);
    }

    @media (max-width: 768px) {
      .games-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
      }

      .page-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }

      .game-thumbnail {
        height: 150px;
        font-size: 60px;
      }

      .game-viewer-header {
        flex-wrap: wrap;
      }

      .game-viewer-title {
        min-width: 200px;
      }
    }
  </style>
</head>
<body class="games-page">
  <div class="page-container">
    <div class="page-header">
      <h1>üéÆ Games</h1>
      <div class="search-container">
        <input 
          type="text" 
          id="searchInput" 
          placeholder="Search games..." 
          autocomplete="off"
        >
        <button class="search-clear" id="clearBtn" onclick="clearSearch()">Clear</button>
      </div>
      <button class="theme-btn" onclick="openThemeModal()" title="Choose theme">üé®</button>
      <a href="/private/dashboard.html" class="back-btn">‚Üê Dashboard</a>
    </div>

    <!-- Recently Played Section -->
    <div class="recently-played" id="recentlyPlayedSection" style="display: none;">
      <div class="section-title">üïê Recently Played</div>
      <div class="recently-played-grid" id="recentlyPlayedGrid"></div>
    </div>

    <!-- Category Filters -->
    <div class="category-filters" id="categoryFilters">
      <button class="category-btn active" data-category="all">All Games</button>
      <button class="category-btn special" data-category="pinned">üìå Pinned</button>
      <button class="category-btn special" data-category="liked">‚ù§Ô∏è Liked</button>
      <button class="category-btn" data-category="action">üî´ Action</button>
      <button class="category-btn" data-category="adventure">üó∫Ô∏è Adventure</button>
      <button class="category-btn" data-category="puzzle">üß© Puzzle</button>
      <button class="category-btn" data-category="racing">üèéÔ∏è Racing</button>
      <button class="category-btn" data-category="sports">‚öΩ Sports</button>
      <button class="category-btn" data-category="strategy">‚ôüÔ∏è Strategy</button>
      <button class="category-btn" data-category="arcade">üëæ Arcade</button>
      <button class="category-btn" data-category="rpg">‚öîÔ∏è RPG</button>
      <button class="category-btn" data-category="simulation">üè† Simulation</button>
      <button class="category-btn" data-category="horror">üëª Horror</button>
      <button class="category-btn" data-category="multiplayer">üë• Multiplayer</button>
    </div>

    <div id="searchResults" class="search-results"></div>
    <div id="errorContainer"></div>
    <div id="gamesGrid" class="games-grid">
      <div class="loading">Loading games...</div>
    </div>
  </div>

  <!-- Game Viewer Modal -->
  <div class="game-viewer" id="gameViewer">
    <div class="game-viewer-header">
      <h2 class="game-viewer-title" id="gameTitleHeader"></h2>
      <div class="game-viewer-buttons">
        <div class="speedrun-section" id="speedrunSection">
          <span class="timer-display" id="timerDisplay">00:00.000</span>
          <button class="timer-btn start-btn" id="timerStartBtn" onclick="toggleTimer()">Start</button>
          <button class="timer-btn reset-btn" onclick="resetTimer()">Reset</button>
          <button class="timer-btn submit-btn" id="submitTimeBtn" onclick="submitSpeedrun()" style="display:none;">Submit</button>
        </div>
        <div class="rating-section" id="ratingSection">
          <span class="rating-label">Rate:</span>
          <div class="star-rating" id="starRating">
            <span class="star" data-rating="1">‚òÖ</span>
            <span class="star" data-rating="2">‚òÖ</span>
            <span class="star" data-rating="3">‚òÖ</span>
            <span class="star" data-rating="4">‚òÖ</span>
            <span class="star" data-rating="5">‚òÖ</span>
          </div>
          <span class="avg-rating" id="avgRating"></span>
        </div>
        <button class="game-btn leaderboard-btn" onclick="showLeaderboard()">üèÜ</button>
        <button class="game-btn fullscreen-btn" onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
        <button class="game-btn exit-btn" onclick="closeGameViewer()">‚úï Exit</button>
      </div>
    </div>
    <div class="game-viewer-content">
      <iframe id="gameFrame"></iframe>
    </div>
  </div>
  
  <!-- Fullscreen exit hint -->
  <div class="fullscreen-hint" id="fullscreenHint">
    Press <kbd>\</kbd> to exit fullscreen
  </div>

  <!-- Leaderboard Modal -->
  <div class="leaderboard-modal" id="leaderboardModal">
    <div class="leaderboard-content">
      <div class="leaderboard-header">
        <h3 id="leaderboardTitle">Leaderboard</h3>
        <button class="leaderboard-close" onclick="closeLeaderboard()">&times;</button>
      </div>
      <div class="leaderboard-tabs">
        <button class="leaderboard-tab active" data-type="scores" onclick="switchLeaderboardTab('scores')">High Scores</button>
        <button class="leaderboard-tab" data-type="speedruns" onclick="switchLeaderboardTab('speedruns')">Speedruns</button>
      </div>
      <div id="leaderboardList"></div>
    </div>
  </div>

  <script src="/js/themes.js"></script>
  <script src="/js/transitions.js"></script>
  <script>
    function checkAuth() {
      const token = localStorage.getItem('authToken');
      if (!token) {
        window.location.href = '/private/auth.html';
        return false;
      }
      return true;
    }

    let allGames = [];
    let filteredGames = [];
    let displayedGames = [];
    let currentIndex = 0;
    const BATCH_SIZE = 50;
    let isLoading = false;
    let isSearching = false;
    let observer = null;
    let currentCategory = 'all';
    
    const iconMap = {
      'Duck Life': 'ü¶Ü',
      'Duck Life 2': 'ü¶Ü',
      'Dogeminer': 'üêï',
      'Doodle Jump': '‚¨ÜÔ∏è'
    };

    // Category detection based on game name keywords
    const categoryKeywords = {
      action: ['shoot', 'gun', 'war', 'fight', 'battle', 'combat', 'strike', 'assault', 'sniper', 'doom', 'quake', 'halo', 'call of duty', 'cod', 'madness', 'metal slug'],
      adventure: ['zelda', 'mario', 'sonic', 'adventure', 'quest', 'kingdom', 'legend', 'metroid', 'hollow knight', 'journey', 'explorer'],
      puzzle: ['puzzle', '2048', 'tetris', 'sudoku', 'match', 'block', 'brain', 'escape', 'riddle', 'slice'],
      racing: ['race', 'racing', 'drift', 'kart', 'car', 'drive', 'speed', 'moto', 'bike', 'road', 'highway', 'nfs', 'need for speed'],
      sports: ['soccer', 'football', 'basketball', 'tennis', 'golf', 'baseball', 'nba', 'nfl', 'fifa', 'sport', 'ball', 'hockey'],
      strategy: ['tower defense', 'strategy', 'war', 'empire', 'kingdom', 'chess', 'civilization', 'bloons', 'td'],
      arcade: ['arcade', 'pac', 'pinball', 'breakout', 'pong', 'snake', 'space invaders', 'clicker', 'idle', 'flappy'],
      rpg: ['pokemon', 'rpg', 'final fantasy', 'dragon', 'quest', 'dungeon', 'persona', 'chrono', 'earthbound', 'mother'],
      simulation: ['simulator', 'simulation', 'tycoon', 'farm', 'restaurant', 'papa', 'cooking', 'build', 'craft'],
      horror: ['horror', 'scary', 'fnaf', 'freddy', 'zombie', 'dead', 'evil', 'nightmare', 'silent hill', 'resident evil'],
      multiplayer: ['io', '.io', 'multiplayer', 'online', 'pvp', '1v1', 'vs', 'agar', 'slither']
    };

    function getGameCategory(gameName) {
      const name = gameName.toLowerCase();
      for (const [category, keywords] of Object.entries(categoryKeywords)) {
        if (keywords.some(kw => name.includes(kw))) {
          return category;
        }
      }
      return 'arcade'; // default category
    }

    document.addEventListener('DOMContentLoaded', async () => {
      if (!checkAuth()) return;
      await loadGames();
      loadRecentlyPlayed();
      setupSearch();
      setupLazyLoad();
      setupCategoryFilters();
      
      // Check for search query from URL
      const urlParams = new URLSearchParams(window.location.search);
      const searchQuery = urlParams.get('search');
      if (searchQuery) {
        const searchInput = document.getElementById('searchInput');
        searchInput.value = searchQuery;
        searchInput.dispatchEvent(new Event('input'));
      }
    });

    // Recently Played Functions
    function getRecentlyPlayed() {
      try {
        return JSON.parse(localStorage.getItem('recentlyPlayedGames') || '[]');
      } catch {
        return [];
      }
    }

    function saveRecentlyPlayed(gameName, gameUrl) {
      let recent = getRecentlyPlayed();
      // Remove if already exists
      recent = recent.filter(g => g.name !== gameName);
      // Add to front
      recent.unshift({ name: gameName, url: gameUrl, timestamp: Date.now() });
      // Keep only last 10
      recent = recent.slice(0, 10);
      localStorage.setItem('recentlyPlayedGames', JSON.stringify(recent));
    }

    function loadRecentlyPlayed() {
      const recent = getRecentlyPlayed();
      const section = document.getElementById('recentlyPlayedSection');
      const grid = document.getElementById('recentlyPlayedGrid');
      
      if (recent.length === 0) {
        section.style.display = 'none';
        return;
      }
      
      section.style.display = 'block';
      grid.innerHTML = recent.map(game => {
        const timeAgo = getTimeAgo(game.timestamp);
        return `
          <div class="recent-game-card" onclick="openGameViewer('${escapeHtml(game.name)}', '${game.url}')">
            <div class="recent-game-thumb">${iconMap[game.name] || 'üéÆ'}</div>
            <div class="recent-game-info">
              <div class="recent-game-name">${escapeHtml(game.name)}</div>
              <div class="recent-game-time">${timeAgo}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function getTimeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
      return Math.floor(seconds / 86400) + 'd ago';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Category Filter Functions
    function setupCategoryFilters() {
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentCategory = btn.dataset.category;
          filterByCategory();
        });
      });
    }

    function filterByCategory() {
      if (currentCategory === 'all') {
        filteredGames = [...allGames];
      } else if (currentCategory === 'pinned') {
        const pinnedNames = getPinnedGames();
        filteredGames = allGames.filter(game => pinnedNames.includes(game.name));
        // Sort by pinned order
        filteredGames.sort((a, b) => pinnedNames.indexOf(a.name) - pinnedNames.indexOf(b.name));
      } else if (currentCategory === 'liked') {
        const likedNames = getLikedGames();
        filteredGames = allGames.filter(game => likedNames.includes(game.name));
        // Sort by liked order
        filteredGames.sort((a, b) => likedNames.indexOf(a.name) - likedNames.indexOf(b.name));
      } else {
        filteredGames = allGames.filter(game => getGameCategory(game.name) === currentCategory);
      }
      displayedGames = [];
      currentIndex = 0;
      const gamesGrid = document.getElementById('gamesGrid');
      gamesGrid.innerHTML = '';
      loadMoreFilteredGames();
    }

    function loadMoreFilteredGames() {
      if (isLoading || currentIndex >= filteredGames.length) return;
      
      isLoading = true;
      const gamesGrid = document.getElementById('gamesGrid');
      const endIndex = Math.min(currentIndex + BATCH_SIZE, filteredGames.length);
      const newGames = filteredGames.slice(currentIndex, endIndex);
      
      displayedGames.push(...newGames);
      const html = newGames.map(game => createGameCard(game)).join('');
      
      if (currentIndex === 0) {
        gamesGrid.innerHTML = html || '<div class="no-results"><div class="no-results-icon">üéÆ</div>No games in this category</div>';
      } else {
        const loaderEl = document.getElementById('lazy-loader');
        if (loaderEl) loaderEl.remove();
        gamesGrid.innerHTML += html;
      }
      
      if (endIndex < filteredGames.length) {
        gamesGrid.innerHTML += '<div id="lazy-loader" class="loading" style="padding: 20px; grid-column: 1/-1; text-align: center;">Loading more...</div>';
        setTimeout(() => setupLazyLoad(), 0);
      }
      
      currentIndex = endIndex;
      isLoading = false;
    }

    async function loadGames() {
      try {
        const response = await fetch('/games.json');
        if (!response.ok) throw new Error('games.json not found');
        
        const games = await response.json();
        const gamesGrid = document.getElementById('gamesGrid');
        
        if (!Array.isArray(games) || games.length === 0) {
          gamesGrid.innerHTML = '<div class="loading">No games available yet.</div>';
          return;
        }

        allGames = games;
        displayedGames = [];
        currentIndex = 0;
        loadMoreGames();
      } catch (err) {
        const errorContainer = document.getElementById('errorContainer');
        document.getElementById('gamesGrid').innerHTML = '<div class="loading">No games loaded.</div>';
        errorContainer.innerHTML = `<div class="error">‚ö†Ô∏è games.json file is required. Please make sure your games data is set up.</div>`;
      }
    }

    function loadMoreGames() {
      if (isLoading || currentIndex >= allGames.length) return;
      
      isLoading = true;
      const gamesGrid = document.getElementById('gamesGrid');
      const endIndex = Math.min(currentIndex + BATCH_SIZE, allGames.length);
      const newGames = allGames.slice(currentIndex, endIndex);
      
      displayedGames.push(...newGames);
      const html = newGames.map(game => createGameCard(game)).join('');
      
      if (currentIndex === 0) {
        gamesGrid.innerHTML = html;
      } else {
        const loaderEl = document.getElementById('lazy-loader');
        if (loaderEl) loaderEl.remove();
        gamesGrid.innerHTML += html;
      }
      
      if (endIndex < allGames.length) {
        gamesGrid.innerHTML += '<div id="lazy-loader" class="loading" style="padding: 20px; grid-column: 1/-1; text-align: center;">Loading more...</div>';
        setTimeout(() => setupLazyLoad(), 0);
      }
      
      currentIndex = endIndex;
      isLoading = false;
    }

    function createGameCard(game) {
      const isPinned = getPinnedGames().includes(game.name);
      const isLiked = getLikedGames().includes(game.name);
      return `
        <div class="game-card">
          <div class="game-actions">
            <button class="game-action-btn pin-btn ${isPinned ? 'active' : ''}" onclick="event.stopPropagation(); togglePin('${game.name}')" title="${isPinned ? 'Unpin' : 'Pin'}">
              üìå
            </button>
            <button class="game-action-btn like-btn ${isLiked ? 'active' : ''}" onclick="event.stopPropagation(); toggleLike('${game.name}')" title="${isLiked ? 'Unlike' : 'Like'}">
              ${isLiked ? '‚ù§Ô∏è' : 'ü§ç'}
            </button>
          </div>
          <div class="game-card-content" onclick="openGameViewer('${game.name}', '${game.url.startsWith('/') ? game.url : '/' + game.url}')">
            <div class="game-thumbnail">${iconMap[game.name] || 'üéÆ'}</div>
            <div class="game-info">
              <h3 class="game-name">${game.name}</h3>
              <p class="game-description">${game.tagline}</p>
              <button class="play-btn">Play Now</button>
            </div>
          </div>
        </div>
      `;
    }

    // Pinned Games Functions
    function getPinnedGames() {
      try {
        return JSON.parse(localStorage.getItem('pinnedGames') || '[]');
      } catch {
        return [];
      }
    }

    function togglePin(gameName) {
      let pinned = getPinnedGames();
      if (pinned.includes(gameName)) {
        pinned = pinned.filter(g => g !== gameName);
      } else {
        pinned.unshift(gameName);
      }
      localStorage.setItem('pinnedGames', JSON.stringify(pinned));
      filterByCategory(); // Refresh view
    }

    // Liked Games Functions
    function getLikedGames() {
      try {
        return JSON.parse(localStorage.getItem('likedGames') || '[]');
      } catch {
        return [];
      }
    }

    function toggleLike(gameName) {
      let liked = getLikedGames();
      if (liked.includes(gameName)) {
        liked = liked.filter(g => g !== gameName);
      } else {
        liked.unshift(gameName);
      }
      localStorage.setItem('likedGames', JSON.stringify(liked));
      filterByCategory(); // Refresh view
    }

    function openGameViewer(gameName, gameUrl) {
      document.getElementById('gameTitleHeader').textContent = gameName;
      document.getElementById('gameFrame').src = gameUrl;
      document.getElementById('gameViewer').classList.add('active');
      document.body.style.overflow = 'hidden';
      
      // Save to recently played
      saveRecentlyPlayed(gameName, gameUrl);
      loadRecentlyPlayed(); // Refresh the display
      
      // Load game rating
      loadGameRating(gameName);
      
      const token = localStorage.getItem('authToken');
      if (token) {
        fetch('/api/activity/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ activity_type: 'playing_game', activity_data: gameName })
        }).catch(() => {});
        
        fetch('/api/xp/activity/game', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ game_name: gameName })
        }).catch(() => {});
      }
    }

    function closeGameViewer() {
      const gameViewer = document.getElementById('gameViewer');
      gameViewer.classList.remove('active');
      gameViewer.classList.remove('fullscreen-mode');
      document.getElementById('gameFrame').src = '';
      document.body.style.overflow = '';
      isFullscreenMode = false;
      
      // Exit fullscreen if active
      if (document.fullscreenElement) {
        document.exitFullscreen().catch(() => {});
      }
    }

    let isFullscreenMode = false;
    let hintTimeout = null;

    function toggleFullscreen() {
      const gameViewer = document.getElementById('gameViewer');
      const hint = document.getElementById('fullscreenHint');
      
      if (!isFullscreenMode) {
        // Enter fullscreen mode - hide header bar
        gameViewer.classList.add('fullscreen-mode');
        isFullscreenMode = true;
        
        // Show hint briefly
        hint.classList.add('show');
        if (hintTimeout) clearTimeout(hintTimeout);
        hintTimeout = setTimeout(() => {
          hint.classList.remove('show');
        }, 3000);
        
        // Also try browser fullscreen
        gameViewer.requestFullscreen().catch(() => {});
      } else {
        exitFullscreenMode();
      }
    }

    function exitFullscreenMode() {
      const gameViewer = document.getElementById('gameViewer');
      const hint = document.getElementById('fullscreenHint');
      
      gameViewer.classList.remove('fullscreen-mode');
      isFullscreenMode = false;
      hint.classList.remove('show');
      
      if (document.fullscreenElement) {
        document.exitFullscreen().catch(() => {});
      }
    }

    // Handle keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      const gameViewer = document.getElementById('gameViewer');
      
      // Backslash (\) to exit fullscreen mode
      if (e.key === '\\' && isFullscreenMode) {
        e.preventDefault();
        exitFullscreenMode();
      }
      
      // Escape to close game viewer entirely
      if (e.key === 'Escape' && gameViewer.classList.contains('active')) {
        if (isFullscreenMode) {
          exitFullscreenMode();
        } else {
          closeGameViewer();
        }
      }
    });

    // Handle browser fullscreen change
    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement && isFullscreenMode) {
        exitFullscreenMode();
      }
    });

    function setupLazyLoad() {
      if (observer) observer.disconnect();
      
      observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && !isLoading && !isSearching) {
            loadMoreGames();
          }
        });
      }, { rootMargin: '100px' });

      const loaderEl = document.getElementById('lazy-loader');
      if (loaderEl) observer.observe(loaderEl);
    }

    function setupSearch() {
      const searchInput = document.getElementById('searchInput');
      const clearBtn = document.getElementById('clearBtn');

      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        const searchResults = document.getElementById('searchResults');
        const gamesGrid = document.getElementById('gamesGrid');

        if (!query) {
          isSearching = false;
          displayedGames = [];
          currentIndex = 0;
          loadMoreGames();
          searchResults.textContent = '';
          clearBtn.classList.remove('show');
          setupLazyLoad();
          return;
        }

        isSearching = true;
        clearBtn.classList.add('show');

        const filtered = allGames.filter(game =>
          game.name.toLowerCase().includes(query) ||
          game.tagline.toLowerCase().includes(query) ||
          game.short.toLowerCase().includes(query)
        );

        searchResults.textContent = `Found ${filtered.length} game${filtered.length !== 1 ? 's' : ''}`;
        
        if (filtered.length === 0) {
          gamesGrid.innerHTML = '<div class="no-results"><div class="no-results-icon">üîç</div><p>No games found</p></div>';
        } else {
          gamesGrid.innerHTML = filtered.map(game => createGameCard(game)).join('');
        }
      });
    }

    function clearSearch() {
      document.getElementById('searchInput').value = '';
      document.getElementById('searchResults').textContent = '';
      document.getElementById('clearBtn').classList.remove('show');
      isSearching = false;
      displayedGames = [];
      currentIndex = 0;
      loadMoreGames();
      setupLazyLoad();
      document.getElementById('searchInput').focus();
    }

    // Star Rating System
    let currentGameName = '';
    let userRating = 0;

    function setupStarRating() {
      const stars = document.querySelectorAll('#starRating .star');
      
      stars.forEach(star => {
        star.addEventListener('mouseenter', () => {
          const rating = parseInt(star.dataset.rating);
          highlightStars(rating);
        });
        
        star.addEventListener('mouseleave', () => {
          highlightStars(userRating);
        });
        
        star.addEventListener('click', () => {
          const rating = parseInt(star.dataset.rating);
          submitRating(rating);
        });
      });
    }

    function highlightStars(rating) {
      const stars = document.querySelectorAll('#starRating .star');
      stars.forEach(star => {
        const r = parseInt(star.dataset.rating);
        star.classList.toggle('active', r <= rating);
      });
    }

    async function loadGameRating(gameName) {
      currentGameName = gameName;
      userRating = 0;
      highlightStars(0);
      document.getElementById('avgRating').textContent = '';

      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/games/ratings/${encodeURIComponent(gameName)}`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        const data = await response.json();
        
        if (data.userRating) {
          userRating = data.userRating.rating;
          highlightStars(userRating);
        }
        
        if (data.total > 0) {
          document.getElementById('avgRating').textContent = `${data.average}‚òÖ (${data.total})`;
        }
      } catch (err) {
        console.error('Failed to load rating:', err);
      }
    }

    async function submitRating(rating) {
      const token = localStorage.getItem('authToken');
      if (!token) {
        alert('Please log in to rate games');
        return;
      }

      try {
        const response = await fetch('/api/games/rate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ gameName: currentGameName, rating })
        });

        if (response.ok) {
          userRating = rating;
          highlightStars(rating);
          loadGameRating(currentGameName); // Refresh average
        }
      } catch (err) {
        console.error('Failed to submit rating:', err);
      }
    }

    // Initialize star rating on page load
    document.addEventListener('DOMContentLoaded', () => {
      setupStarRating();
    });

    // Speedrun Timer System
    let timerInterval = null;
    let timerStartTime = 0;
    let timerElapsed = 0;
    let timerRunning = false;

    function formatTime(ms) {
      const minutes = Math.floor(ms / 60000);
      const seconds = Math.floor((ms % 60000) / 1000);
      const millis = ms % 1000;
      return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(millis).padStart(3, '0')}`;
    }

    function toggleTimer() {
      const display = document.getElementById('timerDisplay');
      const startBtn = document.getElementById('timerStartBtn');
      const submitBtn = document.getElementById('submitTimeBtn');
      
      if (timerRunning) {
        // Stop timer
        clearInterval(timerInterval);
        timerRunning = false;
        timerElapsed = Date.now() - timerStartTime;
        display.classList.remove('running');
        display.classList.add('stopped');
        startBtn.textContent = 'Resume';
        startBtn.classList.remove('running');
        submitBtn.style.display = 'inline-block';
      } else {
        // Start timer
        timerStartTime = Date.now() - timerElapsed;
        timerRunning = true;
        display.classList.add('running');
        display.classList.remove('stopped');
        startBtn.textContent = 'Stop';
        startBtn.classList.add('running');
        submitBtn.style.display = 'none';
        
        timerInterval = setInterval(() => {
          timerElapsed = Date.now() - timerStartTime;
          display.textContent = formatTime(timerElapsed);
        }, 10);
      }
    }

    function resetTimer() {
      clearInterval(timerInterval);
      timerRunning = false;
      timerElapsed = 0;
      timerStartTime = 0;
      
      const display = document.getElementById('timerDisplay');
      const startBtn = document.getElementById('timerStartBtn');
      const submitBtn = document.getElementById('submitTimeBtn');
      
      display.textContent = '00:00.000';
      display.classList.remove('running', 'stopped');
      startBtn.textContent = 'Start';
      startBtn.classList.remove('running');
      submitBtn.style.display = 'none';
    }

    async function submitSpeedrun() {
      const token = localStorage.getItem('authToken');
      if (!token) {
        alert('Please log in to submit speedruns');
        return;
      }

      if (timerElapsed === 0) {
        alert('No time to submit');
        return;
      }

      try {
        const response = await fetch('/api/speedruns/submit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            gameName: currentGameName,
            timeMs: timerElapsed,
            category: 'any%'
          })
        });

        const data = await response.json();
        if (response.ok) {
          let message = `Time submitted: ${formatTime(timerElapsed)}`;
          if (data.isPersonalBest) message += '\nNew Personal Best!';
          if (data.isWorldRecord) message += '\nWORLD RECORD!';
          alert(message);
          resetTimer();
        } else {
          alert(data.error || 'Failed to submit time');
        }
      } catch (err) {
        console.error('Submit error:', err);
        alert('Failed to submit time');
      }
    }

    // Leaderboard System
    let currentLeaderboardType = 'scores';

    function showLeaderboard() {
      document.getElementById('leaderboardModal').classList.add('active');
      document.getElementById('leaderboardTitle').textContent = `${currentGameName} Leaderboard`;
      loadLeaderboardData('scores');
    }

    function closeLeaderboard() {
      document.getElementById('leaderboardModal').classList.remove('active');
    }

    function switchLeaderboardTab(type) {
      currentLeaderboardType = type;
      document.querySelectorAll('.leaderboard-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.type === type);
      });
      loadLeaderboardData(type);
    }

    async function loadLeaderboardData(type) {
      const listEl = document.getElementById('leaderboardList');
      listEl.innerHTML = '<p style="text-align:center;color:var(--text-secondary)">Loading...</p>';

      try {
        const endpoint = type === 'scores' 
          ? `/api/leaderboards/${encodeURIComponent(currentGameName)}`
          : `/api/speedruns/${encodeURIComponent(currentGameName)}`;
        
        const response = await fetch(endpoint);
        const data = await response.json();
        
        const entries = type === 'scores' ? data.leaderboard : data.speedruns;
        
        if (!entries || entries.length === 0) {
          listEl.innerHTML = '<p style="text-align:center;color:var(--text-secondary)">No entries yet. Be the first!</p>';
          return;
        }

        listEl.innerHTML = entries.map((entry, i) => {
          const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
          const value = type === 'scores' ? `${entry.score.toLocaleString()} pts` : formatTime(entry.time_ms);
          
          return `
            <div class="leaderboard-entry">
              <span class="leaderboard-rank ${rankClass}">#${i + 1}</span>
              <img class="leaderboard-avatar" src="${entry.profile_picture || 'https://via.placeholder.com/36'}" alt="">
              <div class="leaderboard-info">
                <div class="leaderboard-name">${escapeHtml(entry.username)}</div>
                <div class="leaderboard-score">${value}</div>
              </div>
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error('Leaderboard load error:', err);
        listEl.innerHTML = '<p style="text-align:center;color:var(--text-secondary)">Failed to load leaderboard</p>';
      }
    }

    function escapeHtml(text) {
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
      return String(text).replace(/[&<>"']/g, m => map[m]);
    }

    // Close leaderboard on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && document.getElementById('leaderboardModal').classList.contains('active')) {
        closeLeaderboard();
      }
    });
  </script>
</body>
</html>
